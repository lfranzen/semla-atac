---
title: "Spatial autocorrelation"
output:
  html_document:
    code_folding: show
editor: visual
editor_options: 
  chunk_output_type: inline
---

```{r message=FALSE, warning=FALSE}
library(STUtility2)
```

`STUtility2` offers a fast method to compute spatial autocorrelation scores for numeric features. 

Spatial autocorrelation is a term used to describe the presence of systematic spatial variation. 
Positive spatial autocorrelation of a feature is the tendency for regions that are close together 
in space to have similar values for that feature.

A simple example is when you have an anatomical structure or a tissue type that spans across multiple 
neighboring spots in an SRT experiment, for example a gland, an immune infiltrate or a region of the brain. 
Inside such structures, you might find that the expression levels of certain genes (or other features) are 
highly similar and hence these genes have a positive spatial autocorrelation.

Perhaps the most widely used method for computing spatial autocorrelation scores is [Moran's I](https://en.wikipedia.org/wiki/Moran%27s_I). 
The computation of Moran's I doesn't scale well and often require some sort of binning strategy to mitigate this problem.

The method provided in `STUtility2` uses a fast alternative which relies on computing the "spatial lag" 
vector of each feature. Here the spatial lag of a numeric feature is defined as the averaged value of that 
feature in adjacent spots. Once this score has been calculated, we can estimate spatial autocorrelation by 
computing the Pearson correlation between the original vector and its spatial lag vector.

We will demonstrate how this work with our mouse brain dataset.

```{r}
se_mbrain <- readRDS(system.file("extdata/mousebrain",
                                 "se_mbrain",
                                 package = "STUtility2"))

# Compute spatial autocorrelation for variable features
spatgenes <- CorSpatialFeatures(se_mbrain)

spatgenes[[1]]
```

By default, the method computes scores for the variable features of the `Seurat` objects returns the results
in a list with one element per tissue section. If we plot the top ranked genes, we will see that these genes
have a distinct spatial profile:

```{r fig.asp=1}
MapFeatures(se_mbrain, features = spatgenes[[1]]$gene[1:6], override_plot_dims = TRUE,
            colors = viridis::magma(n = 11, direction = -1), min_cutoff = 0.1)
```

In contrast, genes with a more random spatial distribution are assigned a low correlation score:

```{r fig.asp=1}
tail(spatgenes[[1]])
MapFeatures(se_mbrain, features = tail(spatgenes[[1]])$gene, 
            override_plot_dims = TRUE,
            colors = viridis::magma(n = 11, direction = -1))
```

